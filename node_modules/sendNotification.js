var postmark = require("postmark")(process.env.POSTMARK_API_KEY);
var config = require('config.json');

function send(to, subject, message, response) {
  postmark.send({
    "From": config.emailSender,
    "To": to,
	"Cc": config.emailReciever,
    "Subject": subject,
    "TextBody": message,
    "Tag": "Join request"
  }, function(error, success) {
    if(error) {
      console.error("Unable to send via postmark: " + error.message);
	  if (response) {
        var rdata = JSON.stringify({"error":error});
	    response.writeHead(401, {"Content-Type": "application/json"});
        response.write(rdata);
	  }
      return;
    } else {
	  var rtnmess = {"success":"sent","to":config.emailReciever,"message":message};
      console.info("Sent to postmark for delivery ");
	  if (response) {
        var rdata = JSON.stringify(rtnmess);
	    response.writeHead(200, {"Content-Type": "application/json"});
	    console.info("Response: " + rdata);
        response.write(rdata);
	  }
    }
	if (response) response.end();	
  });

}; 

exports.send = send;



