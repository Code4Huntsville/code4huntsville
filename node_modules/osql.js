var dbconnect = require('odbcon');

function getOrthoData(sqlString, resp, dbcall) {
  dbconnect.getData(sqlString, dbcall);
  return true;
}

function authorizeUser(uname, pword, resp, logrdata) {
  var sqlStr = "select u.uname, u.fname, u.lname, u.role, u.lastLogOn, u.lastLogOff " +
                  "from Users u, dat d " +
                 "where u.uid = d.pid " +
                   "and u.uname = '"+uname+"' " +
                   "and d.pdat = '"+pword+"';";
  dbconnect.getData(sqlStr, logrdata);
  var now = new Date();
  var jsonDate = now.toJSON();
  sqlStr = "update Users u " +
              "set lastLogOn = '" + jsonDate + "' " +
            "where u.uname = '"+uname+"';";
  dbconnect.getData(sqlStr, null);
}

function logOffUser(uname, resp, logrdata) {
  var now = new Date();
  var jsonDate = now.toJSON();
  sqlStr = "update Users u " +
              "set lastLogOff = '" + jsonDate + "' " +
            "where u.uname = '"+uname+"';";
  dbconnect.getData(sqlStr, logrdata);
}

function getICDCode(thisSession, dbcall) {
  var sqlString = sqlSelectFromClause(thisSession, false) +
                          sqlWhereClause(thisSession) + 
                          ";";
   dbconnect.getData(sqlString, dbcall);
   return true;
}

function prepList(aList) {
  var tmpStr = "'";
  for (i=0;i<aList.length-1;i++) {
    tmpStr = tmpStr.concat(aList[i]+"','");
  }
  tmpStr = tmpStr.concat(aList[aList.length-1]+"'")
  return tmpStr;
}

function getSQL(currentSession) {
  console.log("[osql.getSQL] " + currentSession.userName + " : " + currentSession.anatomyGrp + " : "  + currentSession.side);
  var sqlString = sqlSelectFromClause(currentSession, true) +
                          sqlWhereClause(currentSession) + 
                          "group by "+currentSession.currentCol+", SortOrder DESC " + 
                          "order by SortOrder DESC, " +currentSession.currentCol+";";
  console.log("the String:\n" + sqlString + "\n"); 
  return sqlString;                   
}

function sqlWhereClause(currentSession) {
  var theWhere = "";
  var tmpStr = "where `Injury Of` in ("+prepList(currentSession.injuryGrp)+") " +
                             "and AnatomicGrouping in ("+prepList(currentSession.anatomyGrp)+") ";
                             if (currentSession.a1 != null) {
                               tmpStr = tmpStr.concat("and  A1 = ('"+currentSession.a1+"') ");
                             }
                             if (currentSession.a2 != null) {
                               tmpStr = tmpStr.concat("and  A2 = ('"+currentSession.a2+"') ");
                             }
                             if (currentSession.t1 != null) {
                               tmpStr = tmpStr.concat("and  T1 = ('"+currentSession.t1+"') ");
                             }
                             if (currentSession.t2 != null) {
                               tmpStr = tmpStr.concat("and  T2 = ('"+currentSession.t2+"') ");
                             }
                             if (currentSession.dnd != null) {
                               tmpStr = tmpStr.concat("and  DND = ('"+currentSession.dnd+"') ");
                             }
                             if (currentSession.fb != null) {
                               tmpStr = tmpStr.concat("and  FB = ('"+currentSession.fb+"') ");
                             }
                             if (currentSession.seventh != null) {
                               tmpStr = tmpStr.concat("and  7th = ('"+currentSession.seventh+"') ");
                             }
                             theWhere = tmpStr.concat("and Side in ('"+currentSession.side+"','NS') ") ;
   return theWhere;  
}

function sqlSelectFromClause(currentSession, midSearch) {
  var theSelect = "";
  if (midSearch) {
    theSelect = "select "+currentSession.currentCol+", SortOrder " +
                           "from ICD10Codes " ;
  } else {
    //theSelect = "select 7th, 7thLongText, `ICD 10` , `Long Descriptor`" +
    theSelect = "select A1, A2, T1, T2, DND, FB, 7th, 7thLongText, `ICD 10`, `Long Descriptor`, SortOrder " +
                          "from ICD10Codes " ;
  }
  return theSelect;  
}

exports.getOrthoData = getOrthoData;
exports.getICDCode = getICDCode
exports.authorizeUser = authorizeUser;
exports.logOffUser = logOffUser;
exports.getSQL = getSQL;

/*---- Trash can -----
 
------ */

