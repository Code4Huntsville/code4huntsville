var http = require("http");
var url = require("url");
var router = require('router');
var path = require("path");
var fs = require("fs");
var qs = require("querystring");
var sendReq = require("sendNotification");

function start(request, response) {
  var uri = url.parse(request.url).pathname,
          filename = path.join(process.cwd(), uri);

  var contentTypesByExtension = {
    '.html': "text/html",
    '.css':  "text/css",
    '.js':   "text/javascript",
    '.jpg':  "image/jpeg",
    '.gif':  "image/gif",
    '.png':  "image/png",
    '.ico':  "image/x-icon"
  };

  fs.exists(filename, function(exists) {
    if(!exists) {
      console.log("File not found: " + filename);
      response.writeHead(404, {"Content-Type": "text/plain"});
      response.write("404 Not Found\n");
      response.end();
      return;
    }

    if (fs.statSync(filename).isDirectory() ) filename += '/c4h.html';
	
	console.log("looking for " + filename);
	
    fs.readFile(filename, "binary", function(err, file) {
      if(err) {
        response.writeHead(500, {"Content-Type": "text/plain"});
        response.write(err + "\n");
        response.end();
        return;
      }

      var headers = {};
      var contentType = contentTypesByExtension[path.extname(filename)];
      if (contentType) { headers["Content-Type"] = contentType; console.log("ctype " + contentType);}

      response.writeHead(200, headers);
      response.write(file, "binary");
      response.end();
    });
  });
}
function send(request, response) {
  console.log("Request handler 'send' was called: "  + request.url);
  var body = '';
  var data = '';
  request.on('data', function (data) {
    body += data;
    //  if(body.length > 1e6) // FLOOD ATTACK OR FAULTY CLIENT, NUKE req
    //  {
    //       req.connection.destroy();
    //  }
  });
  request.on('end', function () {
    console.log("Body: " + body);
    var json = JSON.parse(body);
    console.log("message = " + json.emess);
	//var message = JSON.parse(json);
	var messObj = json.emess;
	var txt = "";
    if (messObj.email != null) {
      console.log('message = ' + messObj.name + " " + messObj.email);
      console.log('message obj = ' + messObj.message);	  
      var subj = messObj.name + ": Thank your for your message to Code for Huntsville "
      txt = "Message sent by " + messObj.name + " at " + messObj.email + ". Message ->\n";
      txt = txt.concat(messObj.message);
	  console.log("Body of message: " + txt);
      sendReq.send(messObj.email, subj, txt, response);
    } else {
	  console.log('invalid message = ' + messObj.message);	
	}    		
  });
}

exports.start = start;
exports.send = send;

